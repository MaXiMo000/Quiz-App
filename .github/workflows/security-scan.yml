name: Security Scan with TruffleHog

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest
    name: TruffleHog Security Scan

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for better scanning

    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
        version: latest

    - name: Run TruffleHog on entire repo (fallback)
      if: failure() && github.event_name == 'schedule'
      run: |
        docker run --rm -v "$PWD:/tmp" -w /tmp \
          ghcr.io/trufflesecurity/trufflehog:latest \
          filesystem /tmp \
          --debug --only-verified

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Check if TruffleHog found any issues
          const output = process.env.TRUFFLEHOG_OUTPUT || '';
          if (output.includes('Found unverified results')) {
            console.log('Security issues found by TruffleHog');
            // You can add PR commenting logic here if needed
          } else {
            console.log('No security issues found');
          }
